<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../static/css/bootstrap.min.css" rel="stylesheet" id="bootstrap--min-css">
    <link href="../static/css/custom_dragdrop_v2.css" rel="stylesheet" id="dragdrop2-css">
    <link href="../static/css/bootstrap.css" rel="stylesheet" id="bootstrap-css">
    
    <title>Zipfile Application</title>
    
</head>
<body>

  <!--<script src="../static/js/validatepassword.js"></script>-->
  <script src="../static/js/bootstrap.bundle.js"></script>
  <script src="../static/js/jquery-3.6.0.min.js"></script>

  <nav class="navbar navbar-dark bg-default">
    <a class="navbar-brand" href="#">Zip file system</a>
    
  </nav>
  <br>
  
{% block main %}

<form id="form_upload" method="POST" action="/export" enctype="multipart/form-data" >
<div class="container">
  <div class="row">
    <div class="col"></div>
    <div class="col-6">
      {% if error %}
      <p class=error><strong>Error:</strong> {{ error }}
        {% endif %}
      <p>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class=flashes>
            {% for category, message in messages %}
              <div id="alertmessage">
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>
    <div class="col">
      <input type="hidden" id="datetime_str" name="datetime_str" value="{{datetime_str}}" >
    </div>
  </div>
  <div class="row">
    <div class="col">
        <p><span style="color:rgb(255, 0, 0)">Files list to archive:</span></p>
        <div id="fileList"  >
        </div>
        <input type="hidden" name="selected_filename" id="selected_filename"  > 
    </div>
    <div class="col-6">
      <div class="row">
        <label>Select file(s) to Zip </label>
        <div class="upload-container" >
          <input type="file" id="file_upload" name="files[]" class="form-control" multiple required onchange="updateList()" />
        </div>
      </div>
      <br>
      <div class="row">
        <div class="input-group">
          <div class="input-group-text">
            <input type="radio" id="typPassAutogen" name="typPass" value="autogen" checked  onclick="checkClick()">
          </div>
          <span class="input-group-text">Auto Password</span>
          <input type="text" id="autogen" name="autogen" class="form-control" value="{{autogen}}" readonly >
          <button type="submit" name="submit" id="savepassword_autogen" value="savepassword_autogen" class="btn btn-secondary btn-sm" >Save Password</button>  
        </div>
      </div>
      <br>
      <div class="row">
        <div class="input-group">
          <div class="input-group-text">
            <input type="radio" id="typPassManual" name="typPass" value="manual" onclick="checkClick()" >
          </div>
          <span class="input-group-text"> Manual Create password </span>  
          <input type="text" id="manual" name="manual" class="form-control" style="display: none;"  pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more digits" disabled="true">
          <button type="submit" name="submit" id="savepassword_manual" value="savepassword_manual" class="btn btn-secondary btn-sm"  disabled>Save Password</button>  
        </div>
      </div>
      <br>
      <div class="row">
        <div class="input-group">
          <div class="input-group-text">
            <input type="radio" id="typPassNouse" name="typPass" value="nouse"  onclick="checkClick()">
          </div>
          <span class="input-group-text" > No use password </span>  
          <input type="hidden" id="nouse" name="nouse" class="form-control" >
        </div>
      </div>
      <br>
      <div class="row">
        <div class="progress" id="progressbar" style="display: none;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%">Uploading</div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="text-center">
          <button type="submit" name="submit" value="refresh" class="btn btn-success btn-lg" id="resetbutton" onclick="resetClick()">Reset</button>  
          <button type="submit" class="btn btn-primary btn-lg" name="submit" value="export" id="exportbutton"  title="for zip file download"><img src="../static/img/zipicon.png" width="25px" >Export </button> 
        </div>
      </div>

    </div>
    <div class="col text-center">
      <a href="#howto" title="How to"><img src="../static/img/howto.png" width="50px"></a>
    </div>
  </div>

<br>
</div>

</form>

{% endblock %}
</body>
<footer style="background-color:rgb(220, 251, 252);color:rgb(2, 17, 34);padding:20px;">
  <div class="container">
    
  </div>
</footer>
</html>
  
<script>
  
  window.addEventListener('load', (event) => {
    document.getElementById("typPassAutogen").checked = true;
    checkClick();

  });

  //click export button
  document.getElementById('exportbutton').addEventListener("click", function(){ 
    window.btn_clicked = true; 
  });
  //click reset button
  document.getElementById('resetbutton').addEventListener("click", function(){
    window.btn_clicked = true; 
  });
  //click save password autogen
  document.getElementById('savepassword_autogen').addEventListener("click", function(){ 
    window.btn_clicked = true; 
  });
  //click save password manual
  document.getElementById('savepassword_manual').addEventListener("click", function(){ 
    window.btn_clicked = true; 
  });

  window.onbeforeunload = function(){
    if (!window.btn_clicked) {
        var formupload = document.getElementById("form_upload");
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/closeapp",true);
        xhr.send(new FormData(formupload));
        //return ''
      }
    
  };

  function resetClick(){
    document.getElementById("file_upload").required = false;
    document.getElementById("manual").value = "";
    document.getElementById("manual").required = false;

  }

 
  function checkClick() {
    // Get the checkbox
    var checkBoxAutogen = document.getElementById("typPassAutogen");
    var checkBoxManual = document.getElementById("typPassManual");
    // Get the output text
    var textAutogen = document.getElementById("autogen");
    var textManual = document.getElementById("manual");
    // If the checkbox is checked, display the output text
    if (checkBoxAutogen.checked == true){
      textAutogen.style.display = "block"; 
      document.getElementById("savepassword_autogen").disabled = false;
    } else {
      textAutogen.style.display = "none";
      document.getElementById("savepassword_autogen").disabled = true;
    }

    if (checkBoxManual.checked == true){
      textManual.disabled = false;
      textManual.required = true;
      textManual.style.display = "block";
      document.getElementById("savepassword_manual").disabled = false;
    } else { 
      textManual.disabled = true;
      textManual.required = false;
      textManual.style.display = "none";
      textManual.value = "";
      document.getElementById("savepassword_manual").disabled = true;
    }
 
  } 

 
 
  var children = ""
  var fileList = []
  var selected_filename = document.getElementById('selected_filename');
  updateList = function() {
      var input = document.getElementById('file_upload');
      var output = document.getElementById('fileList');
      var alertmessage = document.getElementById('alertmessage');
      document.getElementById("exportbutton").disabled = true;
      document.getElementById("progressbar").style.display = "block";
      
      for (var i = 0; i < input.files.length; ++i) {
          var namefile = input.files.item(i).name;
          //children += "<li>"+"<button type='button' class='btn-close' aria-label='Close'></button>"+ namefile +"</li>" ;
          fileList.push(input.files[i].name);
          children += "<label class='list-group-item'><input class='form-check-input me-1' type='checkbox' name='selected_filename' checked value='"+namefile+"'>"
            +namefile+"</label>"
      }
      output.innerHTML = "<div class='list-group'>"+children+"</div>";
      //selected_filename.value = fileList[0];
      submitFiles();
      alertmessage.innerHTML =  "<div class='alert alert-warning alert-dismissible fade show' role='alert'>Files upload in process Please wait a moment before clicking Export.</div>"

      
  }

  function submitFiles(){
    var formupload = document.getElementById("form_upload");
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        //alert(xhr.responseText);
        document.getElementById("exportbutton").disabled = false;
        document.getElementById("progressbar").style.display = "none";
    }
}
    xhr.open("POST", "/upload",true);
    //xhr.setRequestHeader("Content-Type", "multipart/form-data");
    xhr.send(new FormData(formupload));
  
  }

  
</script>